name: Update All Mihomo Components

on:
  schedule:
    - cron: '0 13 * * *'  # Daily at 21:00 (UTC+8, Beijing Time)
  workflow_dispatch:
    inputs:
      force_update:
        description: 'Force update even if no changes detected'
        required: false
        type: boolean
        default: false

permissions:
  contents: write

concurrency:
  group: mihomo-all-update
  cancel-in-progress: true

jobs:
  update_config:
    name: Update Config Files
    uses: ./.github/workflows/reusable-mihomo-update.yml
    with:
      script_name: 'auto_update_yaml.py'
      commit_message: |
        chore: update mihomo config files
        
        - Updated fake-ip-filter configurations
        - Auto-generated by scheduled workflow
      target_path: 'Mihomo/'
      timeout_minutes: 10

  update_script:
    name: Update Extension Script
    uses: ./.github/workflows/reusable-mihomo-update.yml
    with:
      script_name: 'auto_update_js.py'
      commit_message: |
        chore: update mihomo extension script
        
        - Updated fake-ip-filter, nameserver-policy, and hosts
        - Auto-generated by scheduled workflow
      target_path: 'Mihomo/Extension_Script/'
      timeout_minutes: 10

  summary:
    name: Update Summary
    runs-on: ubuntu-latest
    needs: [update_config, update_script]
    if: always()
    
    steps:
      - name: Generate summary
        run: |
          echo "## Mihomo Update Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          
          if [[ "${{ needs.update_config.outputs.has_changes }}" == "true" ]]; then
            echo "âœ… **Config files**: Updated successfully" >> $GITHUB_STEP_SUMMARY
          else
            echo "â„¹ï¸ **Config files**: No changes needed" >> $GITHUB_STEP_SUMMARY
          fi
          
          if [[ "${{ needs.update_script.outputs.has_changes }}" == "true" ]]; then
            echo "âœ… **Extension script**: Updated successfully" >> $GITHUB_STEP_SUMMARY
          else
            echo "â„¹ï¸ **Extension script**: No changes needed" >> $GITHUB_STEP_SUMMARY
          fi
          
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "ðŸ• **Completed at**: $(date -u '+%Y-%m-%d %H:%M:%S UTC')" >> $GITHUB_STEP_SUMMARY
